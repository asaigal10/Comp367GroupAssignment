trigger:
- main  

pool:
  name: 'default'  

stages:
- stage: Build
  displayName: 'Build Stage'
  jobs:
  - job: BuildJob
    displayName: 'Build Job'
    steps:
    - task: Checkout@1
      displayName: 'Checkout Code from GitHub'

    - task: UseNode@1
      displayName: 'Set up Node.js'
      inputs:
        versionSpec: '16.x'
        checkLatest: true

    # Install Backend Dependencies
    - script: |
        cd StudentManagementApp/backend
        npm install
      displayName: 'Install Backend Dependencies'

    # Install Frontend Dependencies
    - script: |
        cd StudentManagementApp/frontend
        npm install
      displayName: 'Install Frontend Dependencies'

    # Run Backend Tests with Coverage
    - script: |
        cd StudentManagementApp/backend
        npm test -- --coverage
      displayName: 'Run Backend Tests and Generate Coverage'

    # Run Frontend Tests with Coverage
    - script: |
        cd StudentManagementApp/frontend
        npm test -- --coverage
      displayName: 'Run Frontend Tests and Generate Coverage'

    # Build Frontend
    - script: |
        cd StudentManagementApp/frontend
        npm run build
      displayName: 'Build Frontend'

    # Publish Test Results
    - task: PublishTestResults@2
      displayName: 'Publish Test Results'
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '**/test-results.xml'
        failTaskOnFailedTests: true

    # Publish Code Coverage Results
    - task: PublishCodeCoverageResults@1
      displayName: 'Publish Code Coverage'
      inputs:
        codeCoverageTool: 'Cobertura'
        summaryFileLocation: '**/coverage/cobertura-coverage.xml'
        reportDirectory: '**/coverage'
